---
title: "MEFISTO Analysis"
author: "Cyrus A. Mallon"
date: "22 June 2024"
output:
  html_document:
    toc: true
    df_print: paged
  chunk_output_type: console
  pdf_document:
    toc: true
    number_sections: true
---

# Intro
This is the downstream plotting and analysis, showcasing the results of the MEFISTO analysis. Factor trajectories are first plotted, then their scatter plots, and finally the weights that most influence each trajectory.

# Load and/or Install Necessary Packages
```{r, echo=FALSE}

# install and load packages ----

# list of packages
packages <- c("here", "tidyverse", "MOFA2", "patchwork", "magrittr")

# if package is missing, then install
install_if_missing <- function(pkg) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    if (pkg == "MOFA2") {
      if (!requireNamespace("BiocManager", quietly = TRUE)) {
        install.packages("BiocManager")
      }
      BiocManager::install("MOFA2")
    } else {
      install.packages(pkg, dependencies = TRUE)
    }
  }
}

# install packages ----
for (pkg in packages) {
  install_if_missing(pkg)
}

# load packages----
for (pkg in packages) {
  library(pkg, character.only = TRUE)
}
```

# Load Needed Data
Make sure to change directories if running on your own machine.
```{r, warning=FALSE, message=FALSE}
# load model and data ----
load(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/MOFAobject_untrained_26_01_2024.rda"))
load(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/feature_matrix_26_01_2024.rda"))
load(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/data_for_MOFA_26_01_2024.rda"))

MOFAobject <- load_model(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/LLNEXT_microbiome_model_26_01_2024.hdf5"), load_interpol_Z = FALSE)
```

# Plot Variance Explained By MEFISTO Model
Here I am plotting total variance explained by all factors together and separately.
```{r}
# plot variance explained ----
res_variance <- calculate_variance_explained(MOFAobject)

# how many factors do I want to plot?
start_factor <- 1
end_factor <- 10

# create a vector of factor names
factor_names <- paste0("factor_", seq(start_factor, end_factor))

# plot as bar charts
p_variance_bar_charts <-
as_tibble(res_variance$r2_per_factor$single_group) %>% 
  mutate(factor = all_of(factor_names)) %>%
  mutate(factor = factor(factor, levels = factor_names )) %>%
  ggplot() +
  geom_bar(aes(x = factor, y = microbiome), stat = "identity") +
  ylab("variance explained (%)") +
  xlab("factor") +
  ggtitle("Variance Explained by Factor") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5)) 
  

# examine variance total
p <- plot_variance_explained(MOFAobject, plot_total = T)

# variance decomposition by factor
p_variance_by_factor <-
p[[1]] + theme(axis.text.x = element_text(angle = 90))

# total variance explained per view 
p_variance_total <-
p[[2]] + theme(axis.text.x = element_text(angle = 90))

# plot projections
p_dimensions_reduced <-
plot_factors(MOFAobject, color_by = "time")
```

# Prep data to look at factor trajectories
Here factor trajectories are plotting along the most significant hit from the post-hoc association analysis of high priority phenotypes. (N.B. I excluded some phenotypes that were overlapping. Explained later in text.)
```{r}
# extract NG_IDs and time points (N.B. time here is numeric)
mat <- MOFAobject@covariates$single_group

# convert to matrix
tib <- as_tibble(t(mat))

# set names of matrix
tib$sample <- attr(mat, "dimnames")[[2]]

# get factor scores
z_scores <- as_tibble(MOFAobject@expectations$Z$single_group)
z_scores$sample <- rownames(MOFAobject@expectations$Z$single_group)

# Phenotypes that were significant after post-hoc phenotype analysis
phenotype_data <- MOFAobject@samples_metadata[,c("NG_ID_short", "birth_deliverybirthcard_mode_binary",
                                                 "birth_deliverybirthcard_place_delivery_simple",
                                                 "infant_birthcard_feeding_mode_after_birth",
                                                 "infant_birthcard_feeding_mode_after_birth",
                                                 "mother_health_smoked_one_whole_year_p18",
                                                 "mother_birthcard_parity",
                                                 "infant_misc_sex")]

data <-
  tib %>%
  left_join(., z_scores, by = "sample") %>%
  mutate(NG_ID_short = str_sub(sample, 1, 8)) %>%
  left_join(., phenotype_data, by = c("NG_ID_short")) %>%
  mutate(across(where(is.character), ~na_if(., "<NA>"))) %>%
  mutate(birth_deliverybirthcard_mode_binary = as.factor(birth_deliverybirthcard_mode_binary))
```

# Plot Factor 1 through 6 trajectories.
These factors had significant associations with phenotypes in association_analysis.
All trajectories are amalgamated in the same plot at the end of this code chunk.
```{r}
# fac 1 ----
fac1_colors <- c("#fdb863", "#8073ac") # https://loading.io/color/feature/PuOr-10/ (nice selection of palettes)

fac1_trajectory_sp <-
data %>%
  filter(birth_deliverybirthcard_mode_binary != "nan") %>%
  ggplot(aes(x = time, y = Factor1, group = birth_deliverybirthcard_mode_binary, color = birth_deliverybirthcard_mode_binary)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac1_colors) +
  stat_summary(
    fun = mean,   # calc mean
    geom = "line",  
    aes(group = birth_deliverybirthcard_mode_binary),  # draw lines for each group
    size = 1  
  ) +
  theme_classic() +
  xlab("time (month)") +
  ylab("factor 1 score") +
  labs(color = "birth mode")

fac1_trajectory_bp <-
data %>%
  filter(birth_deliverybirthcard_mode_binary != "nan") %>%
  ggplot(aes(x = birth_deliverybirthcard_mode_binary, y = Factor1, group = birth_deliverybirthcard_mode_binary, color = birth_deliverybirthcard_mode_binary, fill = birth_deliverybirthcard_mode_binary, alpha = 0.5)) +
  geom_boxplot(fill = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  scale_fill_manual(values = fac1_colors) +
  theme_void() +
  labs(fill = "birth mode",
       y = "Factor 1 Scores",
       x = "birthmode") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# fac 2 ----
fac2_trajectory_sp <-
  data %>%
  filter(birth_deliverybirthcard_place_delivery_simple != "nan") %>%
  ggplot(aes(x = time, y = Factor2, group = birth_deliverybirthcard_place_delivery_simple, color = birth_deliverybirthcard_place_delivery_simple)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac1_colors) +
  stat_summary(
    fun = mean,   
    geom = "line",  
    aes(group = birth_deliverybirthcard_place_delivery_simple), 
    size = 1  # 
  ) +
  theme_classic() +
  xlab("time (month)") +
  ylab("factor 2 score") +
  labs(color = "birth place")

fac2_trajectory_bp <-
  data %>%
  filter(birth_deliverybirthcard_place_delivery_simple != "nan") %>%
  ggplot(aes(x = birth_deliverybirthcard_place_delivery_simple, y = Factor2, group = birth_deliverybirthcard_place_delivery_simple, color = birth_deliverybirthcard_place_delivery_simple, fill = birth_deliverybirthcard_place_delivery_simple, alpha = 0.5)) +
  geom_boxplot(fill = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  scale_fill_manual(values = fac1_colors) +
  theme_void() +
  labs(fill = "birth place",
       y = "Factor 2 Scores",
       x = "birthplace") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# fac 3 ----
fac3_colors <- c("#D98481", "#91B5A9", "#7892B5")

fac3_trajectory_sp <-
data %>%
  filter(infant_birthcard_feeding_mode_after_birth != "nan") %>%
  mutate(infant_birthcard_feeding_mode_after_birth = factor(infant_birthcard_feeding_mode_after_birth, levels = c("BF", "MF", "FF") )) %>%
  ggplot(aes(x = time, y = Factor3, group = infant_birthcard_feeding_mode_after_birth, color = infant_birthcard_feeding_mode_after_birth)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac3_colors) +
  stat_summary(
    fun = mean,  
    geom = "line",  
    aes(group = infant_birthcard_feeding_mode_after_birth), 
    size = 1  
  ) +
  labs(color = "feeding mode",
      y = "Factor 3 Scores",
      x = "time (month)") +
  theme_classic() 
  
fac3_trajectory_bp <-
  data %>%
  filter(infant_birthcard_feeding_mode_after_birth != "nan") %>%
  mutate(infant_birthcard_feeding_mode_after_birth = factor(infant_birthcard_feeding_mode_after_birth, levels = c("BF", "MF", "FF") )) %>%
  ggplot(aes(x = infant_birthcard_feeding_mode_after_birth, y = Factor3, group = infant_birthcard_feeding_mode_after_birth, color = infant_birthcard_feeding_mode_after_birth, fill = infant_birthcard_feeding_mode_after_birth, alpha = 0.5)) +
  geom_boxplot(fill = fac3_colors) +
  scale_color_manual(values = fac3_colors) +
  #scale_fill_manual(values = fac3_colors) +
  theme_void() +
  #labs(fill = "feeding mode",
  #     y = "Factor 3 Scores",
  #     x = "birthmode") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# fac 4 ----
fac4_trajectory_sp <-
  data %>%
  filter(mother_health_smoked_one_whole_year_p18 != "nan") %>%
  ggplot(aes(x = time, y = Factor4, group = mother_health_smoked_one_whole_year_p18, color = mother_health_smoked_one_whole_year_p18)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac1_colors) +
  stat_summary(
    fun = mean,  
    geom = "line",  
    aes(group = mother_health_smoked_one_whole_year_p18),  
    size = 1  # Set line size
  ) +
  theme_classic() +
  xlab("time (month)") +
  ylab("factor 4 score") +
  labs(color = "mother smoked?")

fac4_trajectory_bp <-
  data %>%
  filter(mother_health_smoked_one_whole_year_p18 != "nan") %>%
  ggplot(aes(x = mother_health_smoked_one_whole_year_p18, y = Factor4, group = mother_health_smoked_one_whole_year_p18, color = mother_health_smoked_one_whole_year_p18, fill = mother_health_smoked_one_whole_year_p18, alpha = 0.5)) +
  geom_boxplot(fill = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  scale_fill_manual(values = fac1_colors) +
  theme_void() +
  labs(fill = "smoked",
       y = "Factor 4 Scores",
       x = "birthplace") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# fac 5 ----
fac5_trajectory_sp <-
  data %>%
  mutate(mother_birthcard_parity = case_when( # categorize parity
    mother_birthcard_parity == 0 ~ "First",
    mother_birthcard_parity == 1 ~ "Second",
    mother_birthcard_parity == 2 ~ "Third+",
    TRUE ~ NA
  )) %>% 
  filter(!is.na(mother_birthcard_parity)) %>%
  ggplot(aes(x = time, y = Factor5, group = mother_birthcard_parity, color = mother_birthcard_parity)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac3_colors) +
  stat_summary(
    fun = mean,   # Calculate mean
    geom = "line",  # Use line geometry
    aes(group = mother_birthcard_parity),  
    size = 1  # Set line size
  ) +
  theme_classic() +
  xlab("time (month)") +
  ylab("factor 5 score") +
  labs(color = "pairity")

fac5_trajectory_bp <-
  data %>%
  mutate(mother_birthcard_parity = case_when( # categorize parity
    mother_birthcard_parity == 0 ~ "First",
    mother_birthcard_parity == 1 ~ "Second",
    mother_birthcard_parity == 2 ~ "Third+",
    TRUE ~ NA
  )) %>% 
  filter(!is.na(mother_birthcard_parity)) %>%
  mutate(mother_birthcard_parity = factor(mother_birthcard_parity, levels = c("First", "Second", "Third+"))) %>%
  ggplot(aes(x = mother_birthcard_parity, y = Factor5, group = mother_birthcard_parity, color = mother_birthcard_parity, fill = mother_birthcard_parity, alpha = 0.5)) +
  geom_boxplot(fill = fac3_colors) +
  scale_color_manual(values = fac3_colors) +
  scale_fill_manual(values = fac3_colors) +
  theme_void() +
  labs(fill = "pairity",
       y = "Factor 4 Scores",
       x = "birthplace") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# fac 6 ----
fac6_trajectory_sp <-
  data %>%
  filter(!is.na(infant_misc_sex)) %>%
  ggplot(aes(x = time, y = Factor6, group = infant_misc_sex, color = infant_misc_sex)) +
  geom_point(size = 0.5) +
  scale_color_manual(values = fac1_colors) +
  stat_summary(
    fun = mean,   # Calculate mean
    geom = "line",  # Use line geometry
    aes(group = infant_misc_sex),  # Ensure lines are drawn for each group
    size = 1  # Set line size
  ) +
  theme_classic() +
  xlab("time (month)") +
  ylab("factor 6 score") +
  labs(color = "sex")

fac6_trajectory_bp <-
  data %>%
  mutate(mother_birthcard_parity = case_when( # categorize parity
    mother_birthcard_parity == 0 ~ "First",
    mother_birthcard_parity == 1 ~ "Second",
    mother_birthcard_parity == 2 ~ "Third+",
    TRUE ~ NA
  )) %>% 
  ggplot(aes(x = infant_misc_sex, y = Factor6, group = infant_misc_sex, color = infant_misc_sex, fill = infant_misc_sex, alpha = 0.5)) +
  geom_boxplot(fill = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  scale_fill_manual(values = fac1_colors) +
  theme_void() +
  labs(fill = "birth place",
       y = "Factor 6 Scores",
       x = "birthplace") +
  guides(color = "none") +
  scale_fill_discrete(guide="none") +
  scale_alpha(guide = 'none')

# plot all together ----
p_all_trajects <- fac1_trajectory_sp + fac2_trajectory_sp + fac3_trajectory_sp + fac4_trajectory_sp + fac5_trajectory_sp + fac6_trajectory_sp

# save plot
# set dims
indentation_mm <- 15  # Indentation in mm
height_mm <- 297 # A third of the height of an A4 page in mm (â‰ˆ99 mm)

# Define the aspect ratio of your plot (width / height)
aspect_ratio <- 16/9

# Calculate the width based on the aspect ratio and adjust for indentation
width_mm <- (height_mm * aspect_ratio) - (indentation_mm * aspect_ratio)


# Save the plot as a PDF with the specified dimensions
ggsave("trajectories.pdf", plot = p_all_trajects, width = width_mm, height = height_mm, units = "mm")
```

# Plot scatter plots of factor values
Here we are looking at our data in latent space, as in a PCA.
All individual plots appear together at end.

```{r}
## time ----
p_time <-
plot_factors(MOFAobject, color_by = "time", show_missing = FALSE) +
  labs(fill = "time",
      y = "Factor 2 Scores",
      x = "Factor 1 Scores")


## birth mode ----
MOFAobject@samples_metadata$birth_deliverybirthcard_mode_binary <- 
  replace(MOFAobject@samples_metadata$birth_deliverybirthcard_mode_binary, MOFAobject@samples_metadata$birth_deliverybirthcard_mode_binary == "nan", NA)

p_bm <-
plot_factors(MOFAobject, factors = c(2,1), color_by = "birth_deliverybirthcard_mode_binary", show_missing = FALSE) +
  scale_fill_manual(values = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  labs(fill = "birth mode",
       y = "Factor 1 Scores",
       x = "Factor 2 Scores")

## birth place ----
MOFAobject@samples_metadata$birth_deliverybirthcard_place_delivery_simple <- 
  replace(MOFAobject@samples_metadata$birth_deliverybirthcard_place_delivery_simple, MOFAobject@samples_metadata$birth_deliverybirthcard_place_delivery_simple == "nan", NA)

p_bp <-
plot_factors(MOFAobject, factors = c(1,2), color_by = "birth_deliverybirthcard_place_delivery_simple", show_missing = FALSE) +
  scale_fill_manual(values = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  labs(fill = "birth place",
       y = "Factor 2 Scores",
       x = "Factor 1 Scores")

## feeding mode ----
MOFAobject@samples_metadata$infant_birthcard_feeding_mode_after_birth <- 
  replace(MOFAobject@samples_metadata$infant_birthcard_feeding_mode_after_birth, MOFAobject@samples_metadata$infant_birthcard_feeding_mode_after_birth == "nan", NA)

p_fm <-
  plot_factors(MOFAobject, factors = c(1,3), color_by = "infant_birthcard_feeding_mode_after_birth", show_missing = FALSE) +
  scale_fill_manual(values = fac3_colors) +
  scale_color_manual(values = fac3_colors) +
  labs(fill = "feeding mode",
       y = "Factor 3 Scores",
       x = "Factor 1 Scores")

## smoking ----
MOFAobject@samples_metadata$mother_health_smoked_one_whole_year_p18 <- 
  replace(MOFAobject@samples_metadata$mother_health_smoked_one_whole_year_p18, MOFAobject@samples_metadata$mother_health_smoked_one_whole_year_p18 == "nan", NA)

p_smk <-
  plot_factors(MOFAobject, factors = c(1,4), color_by = "mother_health_smoked_one_whole_year_p18", show_missing = FALSE) +
  scale_fill_manual(values = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  labs(fill = "smoked?",
       y = "Factor 4 Scores",
       x = "Factor 1 Scores")

## parity ----
# Replace values in the vector directly
MOFAobject@samples_metadata$mother_birthcard_parity <- 
  ifelse(MOFAobject@samples_metadata$mother_birthcard_parity == 0, "First",
         ifelse(MOFAobject@samples_metadata$mother_birthcard_parity == 1, "Second",
                ifelse(MOFAobject@samples_metadata$mother_birthcard_parity == 2, "Third+", NA)))

p_par <-
  plot_factors(MOFAobject, factors = c(1,5), color_by = "mother_birthcard_parity", show_missing = FALSE) +
  scale_fill_manual(values = fac3_colors) +
  scale_color_manual(values = fac3_colors) +
  labs(fill = "pairity",
       y = "Factor 5 Scores",
       x = "Factor 1 Scores")

## sex ----
# Replace values in the vector directly
MOFAobject@samples_metadata$infant_misc_sex <- 
  replace(MOFAobject@samples_metadata$infant_misc_sex, MOFAobject@samples_metadata$infant_misc_sex == "nan", NA)


p_sex <-
  plot_factors(MOFAobject, factors = c(1,5), color_by = "infant_misc_sex", show_missing = FALSE) +
  scale_fill_manual(values = fac1_colors) +
  scale_color_manual(values = fac1_colors) +
  labs(fill = "sex",
       y = "Factor 6 Scores",
       x = "Factor 1 Scores")


# plot trajectories with box plots ----

########
#
design <-
  "
AC
BD
"
p1 <-
  (guide_area()) + 
  p_bm + 
  guide_area() + 
  fac1_trajectory_bp +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  ) 

p2 <-
  (guide_area()) + 
  p_bp + 
  guide_area() + 
  fac2_trajectory_bp +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  )

p3 <-
  (guide_area()) + 
  p_fm + 
  guide_area() + 
  fac3_trajectory_bp +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  )

p4 <-
  (guide_area()) + 
  p_smk + 
  guide_area() + 
  fac4_trajectory_bp +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  )

p5 <-
  (guide_area()) + 
  p_par + 
  guide_area() + 
  fac5_trajectory_bp +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  )

p6 <-
  (guide_area()) + 
  p_sex + 
  guide_area() + 
  fac6_trajectory_bp +
  plot_layout(
widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  )

p7 <-
  (guide_area()) + 
  p_time + 
  guide_area() + 
  guide_area() +
  plot_layout(
    widths = c(1, 0.125),
    heights = c(0.125, 1),
    design = design
  ) 

p_scatters <- (p1 | p2 | p3) / (p4 | p5 | p6)  # with patchwork library

# save plot
# set dims
indentation_mm <- 15  # in mm
height_mm <- 297 

# define the aspect ratio 
aspect_ratio <- 16/9

# calc width
width_mm <- (height_mm * aspect_ratio) - (indentation_mm * aspect_ratio)


# save as .pdf
ggsave("scatterplots.pdf", plot = p_scatters, width = width_mm, height = height_mm, units = "mm")
```

# plot weights 
These are the species that contribute the most to variation explained across each factor.

```{r, warning=FALSE}
## collapse to species ----
feature_matrix <-
  feature_matrix %>% rename(feature_description = taxon, feature = taxonID)

features_metadata(MOFAobject) <- features_metadata(MOFAobject) %>%
  left_join(.,feature_matrix, by = c("feature")) %>%
  separate(col = feature_description, sep = "\\.",
           into = c("kingdom", "phylum", "class",
                    "order", "family", "genus", "species"),
           remove = FALSE)

# Fac 1 weights----
fac1_colors_weights  <- c("#fdb863", "#8073ac")

df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 1) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>% select(-feature_description) %>% 
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  # cesarean is linked to higher latent values
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

fac1_weights <-
  df_top %>% 
  mutate(birthmode = case_when(
    type == "Negative Weights" ~ "CS",
    type == "Positive Weights" ~ "VG",
    TRUE ~ "undetermined"  
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = birthmode)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac1_colors_weights) +
  ylab("Weight (Factor 1)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac1_weights

# Fac 2 weights----
fac2_colors_weights  <- c("#fdb863", "#8073ac")

df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 2) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>% select(-feature_description) %>% 
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

# plot
fac2_weights <-
  df_top %>% 
  mutate(birthplace = case_when(
    type == "Negative Weights" ~ "home",
    type == "Positive Weights" ~ "hospital",
    TRUE ~ "undetermined"  # Defaults to "undetermined" if other conditions fail
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = birthplace)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac2_colors_weights) +
  ylab("Weight (Factor 2)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac2_weights

# fac3 weights ----
df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 3) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>% select(-feature_description) %>% 
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

fac3_weights <-
  df_top %>% 
  mutate(feedingmode = case_when(
    type == "Negative Weights" ~ "Formula Fed",
    type == "Positive Weights" ~ "Breast Fed",
    TRUE ~ "undetermined"  # Defaults to "undetermined" if other conditions fail
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = feedingmode)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac3_colors) +
  ylab("Weight (Factor 3)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac3_weights

# fac4 weights ----
df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 4) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>% select(-feature_description) %>% 
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

fac4_weights <-
  df_top %>% 
  mutate(smoking = case_when(
    type == "Negative Weights" ~ "yes",
    type == "Positive Weights" ~ "no",
    TRUE ~ "undetermined"  # Defaults to "undetermined" if other conditions fail
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = smoking)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac1_colors) +
  ylab("Weight (Factor 3)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac4_weights

# fac5 weights ----
df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 5) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>% select(-feature_description) %>% 
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

fac5_weights <-
  df_top %>% 
  mutate(pairity = case_when(
    type == "Negative Weights" ~ "first",
    type == "Positive Weights" ~ "second+",
    TRUE ~ "undetermined"  # Defaults to "undetermined" if other conditions fail
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = pairity)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac1_colors) +
  ylab("Weight (Factor 5)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac5_weights

# fac6 weights ----
df_weights1 <- get_weights(MOFAobject, as.data.frame = T, factors = 6) %>%
  left_join(., features_metadata(MOFAobject), by = c("feature", "view"))

# filter out genera with missing genera information and shorten name
df_weights1 %<>% filter(!is.na(genus), species != "s__")
df_weights1 %<>% mutate(species = gsub("s__","", species))
df_weights1 %<>% mutate(species = gsub("\\[","", species))
df_weights1 %<>% mutate(species = gsub("\\]","", species))

# summarize by mean weights across all species in the genus and 
# filter to top 10 positive and negative ones
df_top <- df_weights1 %>% group_by(species) %>%
  select(-feature_description) %>% 
  #print(n = nrow(.))
  summarize(mean_weight = mean(value), n_spec = n()) %>% 
  ungroup() %>% filter(n_spec >= 2 ) %>%
  mutate(type = ifelse(mean_weight < 0, "Negative Weights", "Positive Weights")) %>%
  group_by(type) %>%
  slice_max(abs(mean_weight), n= 5) %>% ungroup() %>% arrange(mean_weight) %>%
  mutate(species = factor(species, levels = .$species))

fac6_weights <-
  df_top %>% 
  mutate(sex = case_when(
    type == "Negative Weights" ~ "female",
    type == "Positive Weights" ~ "male",
    TRUE ~ "undetermined"  
  )) %>%
  ggplot(aes(x= species, y = mean_weight, fill = sex)) + 
  geom_bar(stat="identity") +
  coord_flip() + 
  #theme_bw()  + 
  #theme(legend.position = "top") + 
  xlab("") + 
  #guides(fill = guide_legend(title="")) +
  ggtitle("Influence of Species Across Factor") +
  geom_point(data = filter(df_weights1, species %in% df_top$species),
             aes(x = species, y = value), inherit.aes = FALSE, alpha = 0.3)  +
  scale_fill_manual(values = fac1_colors) +
  ylab("Weight (Factor 6)") +
  theme_classic() +
  theme(#plot.title = element_text(hjust = 0.5),
    text = element_text(size = 10),
    plot.title = element_blank())

fac6_weights

p_weights <- fac1_weights + fac2_weights + fac3_weights + fac4_weights + fac5_weights + fac6_weights

# save plot
# set dims
indentation_mm <- 15  # in mm
height_mm <- 297 

# define the aspect ratio 
aspect_ratio <- 16/9

# calc width
width_mm <- (height_mm * aspect_ratio) - (indentation_mm * aspect_ratio)


# save as .pdf
ggsave("weights.pdf", plot = p_weights, width = width_mm, height = height_mm, units = "mm")
```

# Mixed Modelling: factors ~ phenotypes
The purpose of this analysis is to associate latent variables (i.e, factors) with phenotypes. This was employed in a mixed modelling strategy where factor scores were associated with high priority phenotypes from LL-NEXT. I did remove three phenotypes (birth_delivery_mode_complex, birth_delivery_mode_simple, infant_ffq_ever_never_breastfed) because they  are likely cocorrelated with other phenotypes, such as delivery_mode_binary and feeding mode. 

Phenotypes were associated with factors by creating two models. The first model predicted factor scores using time (as a factor) and phenotype as interacting variables. The second model only use time as a predictor of factor scores. These two models were then compared via a Likelihood Ratio Test (LRT). A significant p-value did not necessarily indicate that the model with phenotype and time was a better fit, but it does suggest that after holding time constant, the phenotype effect is statistically significant. 

Furthermore, The modelling strategy I employed was to first associate factor one with all phenotypes. I then assigned the lowest p-value from the LRT as the strongest association for the factor one, which happened to be birth mode. I then repeated this modelling procedure for factor two; however, I removed birthmode from the list of phenotypes to associate with factor two. This procedure was followed for all following factors. The idea behind this is that every factor should be an independent source of variation, so it would be unnecessary to test its association with other factors. 

# Clear Env and Load Libraries and Data
```{r, warning=FALSE, message = FALSE}
# clear environment
rm(list = ls())

# load libraries
library(kableExtra)
library(lme4)
library(broom)
library(broom.mixed)
library(tidyverse)
library(MOFA2)
library(here)

# load data used for MEFISTO ----
load(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/data_for_MOFA_26_01_2024.rda"))
head(data_for_MOFA)

# load data phenotypes
source(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/prep_phenotypes.R")) # script that prep phenotypes

# load MEFISTO results ----
MOFAobject <- load_model(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/LLNEXT_microbiome_model_26_01_2024.hdf5"), load_interpol_Z = FALSE)
```

# Tidy Data for Modelling
```{r}
# join data and high priority phenotypes
data_for_MOFA <-
data_for_MOFA %>%
  select(-c(40:419)) %>% # drop all phenotypes that were previously added
  left_join(., phenos, by = "NG_ID_short") # add high priority phenotypes from Trishla's selection (but take away some that are likely co correlated)

# make vector of phenotypes
phenotypes <- names(data_for_MOFA)[41:53]

# nest the data to loop over later----
nested_data <- 
  phenotypes %>%
  map(~ data_for_MOFA %>% 
        mutate(Timepoint_categorical = factor(Timepoint_categorical, levels = c("W2", "M1", "M2","M3","M6","M9","M12"))) %>%
        group_by(Timepoint_categorical, sample) %>%
        slice(1) %>% # extract row and sample for all timepoints
        mutate(NEXT_ID = str_extract(SAMPLE_ID, ".*(?=_)")) %>% # extract NEXT_ID
        select(matches(.x),Timepoint_categorical, sample, NEXT_ID) %>% # select entry from phenotype list (looping though via map) 
        right_join(.,get_factors(MOFAobject, as.data.frame = TRUE), by = c("sample")) %>% # join factor values, for all factors, across all samples.
        select(-group) %>%
        nest(data = c(matches(.x),Timepoint_categorical, sample, value, factor, NEXT_ID))) %>% # next data by phenotype
  bind_cols()

# get names of factors ----
factor_names <- colnames(get_factors(MOFAobject)[[1]])
```


# Model Function
```{r}
# function to run mixed model with different params ----
run_MM <- 
  
function(df, phenotype, factor_name){
  
  # remove NAs from data
  df <- df %>% ungroup() %>% filter(factor == factor_name) %>% filter(!is.na(.[[1]]))
  
  # fit model with phenotype
  fit0 <- lmerTest::lmer(as.formula(paste("value ~", phenotype, "* Timepoint_categorical + (1|NEXT_ID)")), data = df, REML = FALSE)
  summary0 <- glance(fit0)
  tidied0 <- tidy(fit0) %>% mutate(phenotype = phenotype, factor = factor_name)
  
  # fit model without phenotype
  fit1 <- lmerTest::lmer(as.formula(paste("value ~ Timepoint_categorical + (1|NEXT_ID)")), data = df, REML = FALSE)
  summary1 <- glance(fit1)
  tidied1 <- tidy(fit1) %>% mutate(phenotype = phenotype, factor = factor_name)
  
  #compare
  model_comparison <- anova(fit0,fit1, model = "LRT")
  model_comparison_tidied <- tidy(model_comparison) %>% mutate(phenotype = phenotype, factor = factor_name)
  
  # store all results in list
  res <- list(fit0,summary0,tidied0,fit1,summary1,tidied1, model_comparison, model_comparison_tidied)
  
  return(res)
  
}
```

# Run Models
This is fast and can be done on a personal machine.
```{r}
# run models----
model_results <- list()
cnt <- 0
phenotypes_to_exclude <- c()

for (j in seq_along(factor_names)) { # for each factor
  p_values <- numeric()
  
  for (i in seq_along(nested_data)) { # for each phenotype
    phenotype_name <- colnames(nested_data[[i]][[1]])[1]
    
    if (phenotype_name %in% phenotypes_to_exclude) { # exclude lowest phenotype from last factor
      next
    }
    
    cnt <- cnt + 1
    res <- run_MM(df = nested_data[[i]][[1]], factor_name = factor_names[[j]], phenotype = phenotype_name)
    
    # extract p-value from model comparison
    if (!is.null(res[[8]]$`p.value`[2])) {
      p_value <- res[[8]]$`p.value`[2]
      p_values <- c(p_values, p_value)
      names(p_values)[length(p_values)] <- phenotype_name
    }
    
    model_results[[cnt]] <- res
  }
  
  # identify the phenotype with the lowest p-value
  if (length(p_values) > 0) {
    phenotype_to_exclude <- names(p_values)[which.min(p_values)]
    phenotypes_to_exclude <- c(phenotypes_to_exclude, phenotype_to_exclude)
  }
}
```


# Table of Results
```{r}
factor_levels <- 
  c(
    "Factor1",
    "Factor2",
    "Factor3",
    "Factor4",
    "Factor5",
    "Factor6",
    "Factor7",
    "Factor8",
    "Factor9",
    "Factor10"
  )

subset_list <- lapply(model_results, function(x) x[[8]]) # extract summary of model comparison

# view results in table
bind_rows(subset_list) %>% 
  mutate(phenotype =
           case_when(phenotype == "birth_birthcard_total_duration_delivery_min" ~ "delivery_duration",
                     phenotype == "birth_deliverybirthcard_mode_binary" ~ "birth_mode",
                     phenotype == "infant_birthcard_feeding_mode_after_birth" ~ "feeding_mode",
                     phenotype == "birth_deliverybirthcard_place_delivery_simple" ~ "delivery_place",
                     phenotype == "mother_birthcard_parity" ~ "parity",
                     phenotype == "family_pets_any" ~ "pets",
                     phenotype == "infant_health_eczema_diagnosis_strict" ~ "eczema",
                     phenotype == "infant_growth_birth_weight_kg" ~ "birth_weight",
                     phenotype == "infant_health_food_allergy" ~ "food_allergy",
                     phenotype == "infant_misc_sex" ~ "sex",
                     phenotype == "mother_birthcard_age_at_delivery" ~ "mother_age",
                     phenotype == "mother_birthcard_duration_water_broken_min" ~ "water_broken_duration",
                     phenotype == "mother_health_smoked_one_whole_year_p18" ~ "smoked",
                     TRUE ~ phenotype)) %>%
    group_by(factor, phenotype) %>%
    filter(!is.na(p.value)) %>%
    ungroup() %>%
    mutate(padj = p.adjust(p.value, method = "BH")) %>% 
    filter(padj < 0.05) %>%
    arrange(factor, padj) %>%
  mutate(factor = factor(factor, levels = factor_levels)) %>%
  select(factor, phenotype, npar, df, p.value, padj) %>%
  arrange(factor, padj) %>% 
  #print(n = nrow(.))
  kable(format = "latex") %>%
  kable_styling() %>%
  cat(collapse = "\n") %>%
  cat("\n\\hline\n")
```

# Examine Top Associations Per Factor
```{r}
# function to extract data from list  
source(here("run_10FAC_BAC_NOGRP_14:59:36_26_01_2024/extract_entry_from_list.R"))

# factor 1  
phenotype <- "birth_deliverybirthcard_mode_binary"
factor <- "Factor1"

extract_list_entry(phenotype = phenotype, factor = factor)

# factor 2  
phenotype <- "birth_deliverybirthcard_place_delivery_simple"
factor <- "Factor2"

extract_list_entry(phenotype = phenotype, factor = factor)

# factor 3  
phenotype <- "infant_birthcard_feeding_mode_after_birth"
factor <- "Factor3"

extract_list_entry(phenotype = phenotype, factor = factor)[[3]] %>% print(n = nrow(.))

# factor 4  
phenotype <- "mother_health_smoked_one_whole_year_p18"
factor <- "Factor4"

extract_list_entry(phenotype = phenotype, factor = factor)

# factor 5  
phenotype <- "mother_birthcard_parity"
factor <- "Factor5"

extract_list_entry(phenotype = phenotype, factor = factor)

# factor 6  
phenotype <- "infant_misc_sex"
factor <- "Factor6"

extract_list_entry(phenotype = phenotype, factor = factor)
  
```









